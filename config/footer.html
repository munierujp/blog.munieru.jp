<script>
(function () {
  window.addEventListener('load', () => {
    addColorCodePreviews()
    addLabelToCodeBlocks()
    makeExternalLinkOpenInNewTab()
  }, false)

  function addColorCodePreviews () {
    getColorCodeElements().forEach(codeElement => {
      const color = codeElement.textContent
      codeElement.outerHTML = `${codeElement.outerHTML}<span class="jp-munieru-blog-color-code-preview" style="background-color: ${color};"></span>`
    })
  }

  function getColorCodeElements () {
    return Array.from(document.getElementsByTagName('code'))
      .filter(codeElement => isColorCode(codeElement.textContent))
  }

  function isColorCode (text) {
    return text.match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/)
  }

  function addLabelToCodeBlocks () {
    getCodeBlockElements().forEach(codeBlockElement => {
      const label = codeBlockElement.parentElement.dataset.label || codeBlockElement.dataset.lang
      if (label) {
        codeBlockElement.dataset.label = label
      }
    })
  }

  function getCodeBlockElements () {
    return Array.from(document.querySelectorAll('.entry-content pre.code'))
  }

  function makeExternalLinkOpenInNewTab () {
    getExternalLinkElements().forEach(linkElement => {
      linkElement.setAttribute('target', '_blank')
      linkElement.setAttribute('rel', 'noopener noreferrer')
    })
  }

  function getExternalLinkElements () {
    return Array.from(document.querySelectorAll(`a[href^="http"]:not([href^="${location.origin}"])`))
  }
})()
</script>

<style>
  .jp-munieru-blog-color-code-preview {
    display: inline-block;
    width: 0.8em;
    height: 0.8em;
    border: 1px solid #d1d5da;
    border-color: rgba(27, 31, 35, 0.15);
    border-radius: 3px;
  }
</style>
